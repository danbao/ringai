# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ringai is a modern, ESM-first Node.js automated UI testing framework for web applications. It provides multi-process parallel test execution, a rich plugin system, multi-browser support (Chrome, Firefox, Safari, Edge) via Playwright, and a TypeScript-native development experience.

- **Node.js:** 22+
- **Package Manager:** pnpm 10+ (`pnpm@10.28.2`)
- **Module System:** ESM-only (`"type": "module"`)
- **TypeScript:** 5.6.3 targeting ES2022

## Development Commands

### Build
```bash
pnpm run build              # Full build (all packages, turbo-orchestrated)
pnpm run build:main         # Build main packages only (excludes e2e-test-app)
pnpm run build:main:watch   # Watch mode for development
```

### Test
```bash
pnpm test                       # Run all tests (unit + E2E headless)
pnpm run test:unit              # Unit tests only (vitest)
pnpm run test:unit:watch        # Unit tests in watch mode
pnpm run test:unit:coverage     # Unit tests with V8 coverage
npx vitest run path/to/file.spec.ts  # Run a single test file
pnpm run test:e2e               # E2E tests (headless Playwright)
pnpm run test:e2e:headed        # E2E tests (headed, browser visible)
pnpm run test:e2e:coverage      # E2E tests with c8 coverage
```

### Lint
```bash
pnpm run lint       # Lint all files (eslint flat config)
pnpm run lint:fix   # Auto-fix lint issues
```

### Package Management
```bash
pnpm run cleanup     # Clean all packages (dist, node_modules artifacts)
pnpm run reinstall   # Clean + install + build from scratch
```

## Architecture

### Monorepo Structure
- **`core/`** — 18 core modules providing framework foundations
- **`packages/`** — 9 extension packages (plugins, utilities, e2e tests)
- **`utils/`** — Build and maintenance scripts
- pnpm workspaces defined in `pnpm-workspace.yaml` with `core/*` and `packages/*`
- All packages use `@ringai/` scope (e.g., `@ringai/transport`, `@ringai/plugin-playwright-driver`)
- Inter-package dependencies use `workspace:*` protocol

### Core Module Dependencies (10-Layer Architecture)
Core modules follow a strict layered dependency hierarchy. Lower layers must not depend on higher layers:

| Layer | Modules | Role |
|-------|---------|------|
| 0 | `types`, `async-breakpoints` | Base types and primitives |
| 1 | `utils`, `pluggable-module` | Shared utilities |
| 2 | `child-process`, `transport` | Process and IPC infrastructure |
| 3 | `logger`, `fs-reader` | Services |
| 4 | `cli-config`, `fs-store` | Configuration and storage |
| 5 | `api`, `plugin-api` | Public APIs |
| 6 | `sandbox`, `test-run-controller`, `reporter` | Advanced orchestration |
| 7 | `test-worker` | Test execution |
| 8 | `cli` | Command-line interface (citty) |
| 9 | `ringai` | Entry point |

### Build Pipeline
- **tsup** compiles each package to ESM with sourcemaps (base config: `tsup.config.base.ts`)
- **turbo** orchestrates builds respecting `^build` dependency chain (`turbo.json`)
- Type declarations generated by TypeScript separately (`dts: false` in tsup)
- Each package has `tsup.config.ts`, `tsconfig.json` (extends `tsconfig.base.json`), and `tsconfig.build.json`

### Key Architectural Patterns

**Inter-Process Communication:** The `transport` package provides EventEmitter-based IPC with `send` (point-to-point async), `broadcast` (sync), and event subscription (`on`/`once`).

**Plugin System:** Built on `hookable`. Plugins receive a `PluginAPI` instance providing access to Logger, FSReader, TestWorker, TestRunController, BrowserProxy, and FSStoreServer modules. Follow existing patterns in `packages/plugin-*`.

**Error Hierarchy:** `RingaiError` base class with specialized types: `TransportError`, `PluginError`, `ConfigError`, `WorkerError`.

**CLI:** Built with `citty`. Subcommands: `run`, `init`, `plugin`. Configuration files: `.ringairc` (JSON), `.ringairc.js` (ESM), `.ringairc.cjs` (CJS).

## TypeScript Strictness

The project uses maximum TypeScript strictness (`tsconfig.base.json`). Beyond `strict: true`, these additional checks are enabled:
- `exactOptionalPropertyTypes` — optional properties cannot be explicitly `undefined` unless typed as such
- `noUncheckedIndexedAccess` — index access returns `T | undefined`
- `noPropertyAccessFromIndexSignature` — must use bracket notation for index signatures
- `noImplicitOverride` — override keyword required
- `noUnusedLocals` / `noUnusedParameters` — no dead code

## Testing Details

**Unit tests** (Vitest): Files matching `core/*/test/**/*.spec.ts` and `packages/*/test/**/*.spec.ts`. Some functional tests are excluded from the unit test suite (see `vitest.config.ts` exclude list) — these run separately. Test timeout: 60s, hook timeout: 30s. Coverage outputs to `.coverage/`.

**E2E tests**: Run via the `@ringai/e2e-test-app` package using ringai's own test runner with Playwright. Coverage via c8, outputs to `c8-cov/`. E2E tests use a local test server or Cloudflare Worker for test fixtures.

## ESLint Notes

- Flat config (`eslint.config.js`) with `typescript-eslint` and `sonarjs` plugins
- `@typescript-eslint/no-explicit-any` is **off** — `any` is allowed
- `no-console` is **warn** — prefer the logger module
- Unused vars with `_` prefix are allowed (`_arg` pattern)
