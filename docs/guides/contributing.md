# Contributing to Testring

Thank you for your interest in contributing to testring! This guide will help you get started.

## Prerequisites

Before you begin, ensure you have:

- **Node.js 22+** (ES2022 target, ESM-first)
- **pnpm 9+** (package manager for the monorepo)
- **Git**
- A GitHub account

## Setting Up the Development Environment

1. **Fork the repository** on GitHub

2. **Clone your fork** locally:
   ```bash
   git clone https://github.com/YOUR_USERNAME/testring.git
   cd testring
   ```

3. **Add the upstream remote**:
   ```bash
   git remote add upstream https://github.com/danbao/testring.git
   ```

4. **Install dependencies**:
   ```bash
   pnpm install
   ```

5. **Build the project** (uses turbo + tsup to build all packages):
   ```bash
   pnpm run build:main
   ```

6. **Run tests** to ensure everything works:
   ```bash
   pnpm run test:unit
   ```

## Development Workflow

### Creating a Feature Branch

1. **Sync with upstream**:
   ```bash
   git checkout master
   git pull upstream master
   ```

2. **Create a feature branch**:
   ```bash
   git checkout -b feature/your-feature-name
   ```

### Making Changes

1. Make your changes in the appropriate package under `core/` or `packages/`
2. Add tests for new functionality (Vitest `.spec.ts` files)
3. Update documentation if needed
4. Run checks locally:
   ```bash
   pnpm run test:unit
   pnpm run lint
   pnpm run build:main
   ```

### Submitting Changes

1. **Create a changeset** to document your change for versioning:
   ```bash
   pnpm changeset
   ```
   Follow the prompts to select affected packages and describe the change.

2. **Commit your changes** following Conventional Commits:
   ```bash
   git add .
   git commit -m "feat: add new feature description"
   ```

3. **Push to your fork**:
   ```bash
   git push origin feature/your-feature-name
   ```

4. **Create a Pull Request** on GitHub against `danbao/testring`

## Project Structure

```
testring/
├── core/                 # Core framework modules (~20 packages)
│   ├── api/             # Test execution API
│   ├── cli/             # Command-line interface (citty)
│   ├── child-process/   # Child process management
│   ├── transport/       # IPC communication
│   ├── types/           # TypeScript type definitions
│   └── ...
├── packages/            # Extension packages
│   ├── plugin-playwright-driver/  # Playwright browser driver
│   ├── plugin-babel/              # Babel integration
│   ├── plugin-fs-store/           # File system storage
│   └── ...
├── docs/                # Documentation
├── scripts/             # Build and utility scripts
├── utils/               # Build and maintenance utilities
├── tsup.config.base.ts  # Shared tsup build config
├── tsconfig.base.json   # Shared TypeScript config
├── turbo.json           # Turbo pipeline config
├── vitest.config.ts     # Vitest test config
├── eslint.config.js     # ESLint flat config
└── pnpm-workspace.yaml  # pnpm workspace config
```

### Package Structure

Each package follows a consistent layout:

```
core/my-package/
├── src/              # TypeScript source files (ESM)
├── test/             # Test files (*.spec.ts)
├── dist/             # Built output (ESM, generated by tsup)
├── package.json      # "type": "module", workspace dependencies
├── tsconfig.json     # Extends ../../tsconfig.base.json
└── tsup.config.ts    # tsup build configuration
```

All packages use `"type": "module"` in `package.json` and compile to ESM output via tsup.

## Available Commands

### Build

```bash
# Full build (all packages, turbo-orchestrated)
pnpm run build

# Build main packages only (excludes e2e-test-app, devtool-frontend, devtool-extension)
pnpm run build:main

# Watch mode for development
pnpm run build:main:watch
```

### Testing

```bash
# Run unit tests (Vitest)
pnpm run test:unit

# Run unit tests with coverage (V8 provider)
pnpm run test:unit:coverage

# Run unit tests in watch mode
pnpm run test:unit:watch

# Run a single test file
npx vitest run path/to/file.spec.ts

# Run E2E tests (headless)
pnpm run test:e2e:headless

# Run E2E tests with coverage
pnpm run test:e2e:coverage:lcov

# Run all tests (unit + E2E)
pnpm test
```

### Linting

```bash
# Lint all files (ESLint flat config)
pnpm run lint

# Fix linting issues
pnpm run lint:fix
```

### Package Management

```bash
# Clean all packages
pnpm run cleanup

# Reinstall all dependencies
pnpm run reinstall

# Check for dependency updates
pnpm run deps:find-updates
```

## Build System

The build pipeline uses three tools working together:

- **pnpm workspaces** — Manages dependencies across the monorepo
- **turbo** — Orchestrates build/test/lint tasks with caching and correct dependency ordering
- **tsup** — Compiles each package to ESM (ES2022 target, with sourcemaps)

Each package has its own `tsup.config.ts` that extends the shared `tsup.config.base.ts` at the project root. Turbo handles the build ordering automatically based on inter-package dependencies.

## TypeScript Guidelines

- **Target:** ES2022
- **Module:** ES2022 with bundler resolution
- **Strict mode** enabled with all strict flags
- Use ESM imports (e.g., `import from 'node:path'`, `import from 'node:url'`)
- Use meaningful variable and function names
- Add proper type annotations
- Document complex functions with JSDoc comments

## Testing with Vitest

All tests use **Vitest** as the testing framework. The root `vitest.config.ts` configures test inclusion and exclusion patterns.

- Place tests in the `test/` directory of each package
- Name test files with `.spec.ts` extension
- Use descriptive test names

**Example:**

```typescript
import { describe, it, expect } from 'vitest';

describe('MyModule', () => {
  it('should process data correctly', async () => {
    const result = await processData({ input: 'test' });

    expect(result.success).toBe(true);
    expect(result.output).toBe('processed');
  });
});
```

## Commit Message Format

We follow [Conventional Commits](https://conventionalcommits.org/):

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

**Types:**

| Type       | Description                           |
| ---------- | ------------------------------------- |
| `feat`     | A new feature                         |
| `fix`      | A bug fix                             |
| `docs`     | Documentation changes                 |
| `style`    | Code style changes (formatting, etc.) |
| `refactor` | Code refactoring                      |
| `test`     | Adding or updating tests              |
| `chore`    | Maintenance tasks                     |

**Examples:**
```
feat(api): add new endpoint for test execution
fix(child-process): resolve tsx loader path on Windows
docs(readme): update installation instructions
```

## Versioning with Changesets

This project uses [Changesets](https://github.com/changesets/changesets) for version management. When you make a user-facing change:

1. Run `pnpm changeset` to create a changeset file
2. Select the affected packages
3. Choose the semver bump type (patch, minor, major)
4. Write a summary of the change
5. Commit the generated `.changeset/*.md` file with your PR

The changeset will be consumed during the release process to update package versions and generate changelogs.

## Plugin Development

Use the `@testring/plugin-api` package for creating new plugins. Follow existing plugin patterns in the `packages/` directory:

- `plugin-playwright-driver` — Playwright browser automation
- `plugin-babel` — Babel transpilation support
- `plugin-fs-store` — File system storage

See the [Plugin Development Guide](./plugin-development.md) for detailed instructions.

## Pull Request Process

### Before Submitting

1. Run the full check suite:
   ```bash
   pnpm run test:unit
   pnpm run lint
   pnpm run build:main
   ```

2. Ensure your changeset is included (if applicable)

3. Review your diff for unintended changes or debug code

### PR Requirements

- [ ] All tests pass
- [ ] Code follows existing style and conventions
- [ ] Documentation is updated (if applicable)
- [ ] Changeset is included for user-facing changes
- [ ] Breaking changes are documented
- [ ] ESM compatibility maintained (`"type": "module"`)

### Review Process

1. Automated CI checks run on PR creation
2. Maintainer review for code quality and architecture
3. Cross-platform testing if needed
4. Approval and merge by maintainers

## IDE Setup

### VS Code Extensions

- TypeScript and JavaScript Language Features
- ESLint
- GitLens

### Recommended Settings

```json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": "explicit"
  },
  "typescript.preferences.importModuleSpecifier": "relative"
}
```

## Getting Help

- **Documentation**: Check the `docs/` directory first
- **Issues**: Search existing issues before creating new ones
- **Discussions**: Use GitHub Discussions for questions

Thank you for contributing to testring!
